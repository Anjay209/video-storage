<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="create.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <!-- Section Header -->
  <div class="section-header-background">
    <div class="section-header-inline">
      <h1 class="unit-title"><span class="name">Practice Hub</span></h1>
    </div><div class="question-tabs">
        <div class="tab" onclick="selectTab(this)">Resources</div>
        <div class="tab active" onclick="selectTab(this)">Create</div> 
        <div class="tab" onclick="selectTab(this)">Judging</div> 
      </div>
      <div class="tab-underline"></div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
        <li>üè† <span class="nav-label">Dashboard</span></li>
        <li>üìä <span class="nav-label">Stats</span></li>
        <li>üéØ <span class="nav-label">Goals</span></li>
        <li>üìÖ <span class="nav-label">Schedule</span></li>
        <li>‚öôÔ∏è <span class="nav-label">Settings</span></li>
      </ul>
    </aside>

    <!-- Sub Sidebar -->
    <aside class="sub-sidebar">
      <div class="sidebar-header">
        <span>Physics</span>
        <span class="dots">‚ãØ</span>
      </div>
      <div class="sub-nav-wrapper">
        <ul class="sub-nav">
          <li class="active">üì∂ My Journey</li>
          <li>üéì Certify</li>
          <li>üèÜ Leaderboard</li>
          <li>‚ÑπÔ∏è About</li>
        </ul>
      </div>
    </aside>
  </div>

  <div class="content">
    <div class="exam-summary-container">
        <!-- Exam Creation -->
        <div class="create-exam-card">
          <h2>Create your Practice</h2>
          <p>We‚Äôll generate an exam based on what you want to practice</p>
          <div class="exam-buttons">
            <button onclick="openWrittenModal()">Open Written Modal</button>
            <button class="speaking-btn" onclick="openSpeakingModal()">Speaking</button>
            <button onclick="openCaseModal()">Case</button>
          </div>
        </div>
      
        <!-- Score + Breakdown -->
        <div class="performance-section">
          <div class="performance-summary">
            <div class="score-ring">
              <svg viewBox="0 0 36 36">
                <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831"/>
                <path class="progress" stroke-dasharray="90, 100" d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831"/>
                <text x="18" y="20.35" class="percentage">90%</text>
              </svg>
            </div>
            <div class="score-details">
              <p><strong>Correct</strong> <span class="blue">18</span></p>
              <p><strong>Incorrect</strong> <span class="gray">2</span></p>
              <p><strong>Skipped</strong> <span class="gray">0</span></p>
            </div>
          </div>
      
          <div class="performance-breakdown">
            
            <ul>
              <li>Booleans and Logic <span>2 / 2</span></li>
              <li>Arrays and ArrayLists <span>6 / 6</span></li>
              <li>Iteration <span>3 / 5</span></li>
              <li>Recursion <span>3 / 3</span></li>
              <li>Primitive Types <span>2 / 2</span></li>
              <li>Inheritance <span>1 / 1</span></li>
              <li>2D Arrays <span>1 / 1</span></li>
            </ul>
          </div>
        </div>
      </div>      
  </div>
  <!-- Written Practice Modal -->
<div id="writtenModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeWrittenModal()">&times;</span>
      <h2>Written Practice Setup</h2>
  
      <div class="modal-section">
        <label><strong>Time:</strong></label>
        <div class="time-options">
          <button class="time-btn" onclick="selectTime(this)">15 min</button>
          <button class="time-btn" onclick="selectTime(this)">30 min</button>
          <button class="time-btn" onclick="selectTime(this)">50 min</button>
        </div>
      </div>
  
      <div class="modal-section">
        <label><strong>Competencies Tested</strong></label><br>
        
        <div class="checkbox-group">
          <label><input type="checkbox" class="competency-option" value="Business Communication"> Business Communication</label>
          <label><input type="checkbox" class="competency-option" value="Marketing"> Marketing</label>
          <label><input type="checkbox" class="competency-option" value="Accounting"> Accounting</label>
          <label><input type="checkbox" class="competency-option" value="Economics"> Economics</label>
          <!-- Add more as needed -->
          <button type="button" class="select-all-btn" onclick="selectAllCompetencies()">Select All</button>
        </div>
      </div>
      
  
      <div class="modal-section">
        <label><strong>Difficulty:</strong></label>
        <div class="difficulty-options">
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Easy</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Medium</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Hard</button>
        </div>
      </div>
  
      <div class="checkbox-row">
        <input type="checkbox" id="simulate" />
        <label for="simulate">Simulate BluePanda testing environment</label>
      </div>
  
      <button class="start-btn">Start Practice</button>
    </div>
  </div>

  <!-- SPEAKING MODAL -->
<div class="modal speaking-modal hidden" id="speakingModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('speakingModal')">&times;</span>
      <h2>Speaking Practice</h2>
  
      <div class="modal-section">
        <label for="speechInput"><strong>Paste Your Speech</strong></label>
        <textarea id="speechInput" placeholder="Paste your speech here..." rows="6"></textarea>
      </div>
  
      <button onclick="generateQuestions()">Generate Questions</button>
  
      <div class="modal-section hidden" id="questionArea">
        <h3>Generated Questions</h3>
        <div id="questionList" class="question-card-list"></div>
  
        <label><strong>Record your responses:</strong></label>
        <div class="recording-options">
          <button onclick="startAudio('speaking')">üé§ Audio</button>
          <button onclick="startVideo('speaking')">üìπ Video</button>
        </div>
  
        <div class="media-preview">
          <audio id="audioPlaybackSpeaking" controls style="display: none; margin-top: 1rem;"></audio>
          <video id="videoPreviewSpeaking" style="display: none; margin-top: 1rem; max-width: 100%; border-radius: 10px;" autoplay playsinline muted></video>
        </div>
  
        <button id="stopBtnSpeaking" class="stop-recording-btn" style="display: none; margin-top: 1rem;" onclick="stopRecording('speaking')">‚èπÔ∏è Stop Recording</button>
  
        <label><input type="checkbox" id="simulateJudge"> Simulate BluePanda Judging</label>
      </div>
    </div>
  </div>
  
  <!-- CASE MODAL -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('caseModal')">&times;</span>
      <h2>Case Practice</h2>
  
      <div id="casePromptSection">
        <p><strong>Choose up to 5 competencies:</strong></p>
        <div class="competency-grid">
          <label><input type="checkbox" class="competency-option" /> Teamwork</label>
          <label><input type="checkbox" class="competency-option" /> Leadership</label>
          <label><input type="checkbox" class="competency-option" /> Innovation</label>
          <label><input type="checkbox" class="competency-option" /> Communication</label>
          <label><input type="checkbox" class="competency-option" /> Ethics</label>
        </div>
  
        <p><strong>Select difficulty:</strong></p>
        <div class="difficulty-options">
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Easy</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Medium</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Hard</button>
        </div>
  
        <br />
        <button class="generate-btn" onclick="generateCase()">Generate Case</button>
      </div>
  
      <div id="caseResultSection" style="display: none;">
        <div style="background:#f3f6fa; padding:1rem; border-radius:8px;">
          <h3>üß† Your Case Prompt</h3>
          <p><strong>Difficulty:</strong> <span id="caseDifficulty"></span></p>
          <p><strong>Focus Competencies:</strong> <span id="caseCompetencies"></span></p>
          <p style="margin-top:1rem;" id="caseText">
            <em>You are part of a team launching a new tech startup...</em>
          </p>
        </div>
  
        <div id="caseRecording" style="margin-top: 1.5rem;">
          <label><strong>üéôÔ∏è Record your response:</strong></label>
          <div style="display: flex; gap: 1rem; margin-top: 0.75rem;">
            <button onclick="startAudio('case')">Audio</button>
            <button onclick="startVideo('case')">Video</button>
            <button id="stopBtnCase" onclick="stopRecording('case')" style="display: none;">‚èπÔ∏è Stop</button>
          </div>
  
          <div class="media-preview">
            <audio id="audioPlaybackCase" controls style="display: none; margin-top: 1rem;"></audio>
            <video id="videoPreviewCase" style="display: none; margin-top: 1rem; max-width: 100%; border-radius: 10px;" autoplay playsinline muted></video>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  
  
  
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

  
  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

firebase.auth().onAuthStateChanged(async user => {
  if (!user) return;
  
  const assignmentsRef = firebase.firestore().collection('assignments');
  const snapshot = await assignmentsRef
    .where('to', '==', user.uid)
    .where('type', 'in', ['written', 'quiz'])
    .where('status', '==', 'complete')
    .orderBy('createdAt', 'desc')
    .get();
  
  if (snapshot.empty) return;
  
  const allQuizzes = snapshot.docs.map(doc => doc.data());
  
  // Hide the original performance section entirely
  const originalPerformanceSection = document.querySelector('.performance-section');
  if (originalPerformanceSection) {
    originalPerformanceSection.style.display = 'none';
  }
  
  // Create a new container for all quiz cards
  const quizContainer = document.createElement('div');
  quizContainer.className = 'quiz-container';
  quizContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 2rem;
  `;
  
  // Create individual quiz cards
  allQuizzes.forEach((quiz, index) => {
    const quizCard = createIndividualQuizCard(quiz, index + 1);
    quizContainer.appendChild(quizCard);
  });
  
  // Insert the quiz container after the create-exam-card
  const createExamCard = document.querySelector('.create-exam-card');
  if (createExamCard) {
    createExamCard.parentNode.insertBefore(quizContainer, createExamCard.nextSibling);
  }
});

// Updated function to create individual quiz cards
function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create header with title and date
  const header = document.createElement('div');
  header.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  `;



  header.appendChild(title);
  header.appendChild(dateSpan);

  // Create main content container
  const mainContent = document.createElement('div');
  mainContent.style.cssText = `
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  `;

  // Create circular progress and stats section
  const leftSection = document.createElement('div');
  leftSection.style.cssText = `
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  `;

  // Create circular progress
  const circularProgress = document.createElement('div');
  circularProgress.style.cssText = `
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#3b82f6 0deg ${overallPercentage * 3.6}deg, #e5e7eb ${overallPercentage * 3.6}deg 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  const innerCircle = document.createElement('div');
  innerCircle.style.cssText = `
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3b82f6;
  `;
  innerCircle.textContent = `${overallPercentage}%`;

  circularProgress.appendChild(innerCircle);

  // Create stats below circle
  const stats = document.createElement('div');
  stats.style.cssText = `
    text-align: center;
  `;

  const correctDiv = document.createElement('div');
  correctDiv.innerHTML = `<strong>Correct</strong> ${correctAnswers}`;
  correctDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const incorrectDiv = document.createElement('div');
  incorrectDiv.innerHTML = `<strong>Incorrect</strong> ${totalQuestions - correctAnswers}`;
  incorrectDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const skippedDiv = document.createElement('div');
  skippedDiv.innerHTML = `<strong>Skipped</strong> 0`;
  skippedDiv.style.cssText = `
    color: #1f2937;
  `;

  stats.appendChild(correctDiv);
  stats.appendChild(incorrectDiv);
  stats.appendChild(skippedDiv);

  leftSection.appendChild(circularProgress);
  leftSection.appendChild(stats);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections (right side)
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyItem = document.createElement('div');
    competencyItem.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;

    const competencyName = document.createElement('span');
    competencyName.textContent = competency;
    competencyName.style.cssText = `
      font-weight: 500;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('span');
    competencyStats.textContent = `${competencyCorrect} / ${competencyTotal}`;
    competencyStats.style.cssText = `
      color: #6b7280;
      font-weight: 500;
    `;

    competencyItem.appendChild(competencyName);
    competencyItem.appendChild(competencyStats);
    competencyContainer.appendChild(competencyItem);
  });

  mainContent.appendChild(leftSection);
  mainContent.appendChild(competencyContainer);

  // Assemble the card
  card.appendChild(header);
  card.appendChild(mainContent);

  return card;
}

function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create header with title and date
  const header = document.createElement('div');
  header.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  `;

  const title = document.createElement('h3');
  title.textContent = `Performance breakdown`;
  title.style.cssText = `
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  `;

  const dateSpan = document.createElement('span');
  dateSpan.textContent = new Date().toLocaleString();
  dateSpan.style.cssText = `
    color: #6b7280;
    font-size: 0.875rem;
  `;

  header.appendChild(title);
  header.appendChild(dateSpan);

  // Create main content container
  const mainContent = document.createElement('div');
  mainContent.style.cssText = `
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  `;

  // Create circular progress and stats section
  const leftSection = document.createElement('div');
  leftSection.style.cssText = `
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  `;

  // Create circular progress
  const circularProgress = document.createElement('div');
  circularProgress.style.cssText = `
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#3b82f6 0deg ${overallPercentage * 3.6}deg, #e5e7eb ${overallPercentage * 3.6}deg 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  const innerCircle = document.createElement('div');
  innerCircle.style.cssText = `
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3b82f6;
  `;
  innerCircle.textContent = `${overallPercentage}%`;

  circularProgress.appendChild(innerCircle);

  // Create stats below circle
  const stats = document.createElement('div');
  stats.style.cssText = `
    text-align: center;
  `;

  const correctDiv = document.createElement('div');
  correctDiv.innerHTML = `<strong>Correct</strong> ${correctAnswers}`;
  correctDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const incorrectDiv = document.createElement('div');
  incorrectDiv.innerHTML = `<strong>Incorrect</strong> ${totalQuestions - correctAnswers}`;
  incorrectDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const skippedDiv = document.createElement('div');
  skippedDiv.innerHTML = `<strong>Skipped</strong> 0`;
  skippedDiv.style.cssText = `
    color: #1f2937;
  `;

  stats.appendChild(correctDiv);
  stats.appendChild(incorrectDiv);
  stats.appendChild(skippedDiv);

  leftSection.appendChild(circularProgress);
  leftSection.appendChild(stats);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections (right side)
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyItem = document.createElement('div');
    competencyItem.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;

    const competencyName = document.createElement('span');
    competencyName.textContent = competency;
    competencyName.style.cssText = `
      font-weight: 500;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('span');
    competencyStats.textContent = `${competencyCorrect} / ${competencyTotal}`;
    competencyStats.style.cssText = `
      color: #6b7280;
      font-weight: 500;
    `;

    competencyItem.appendChild(competencyName);
    competencyItem.appendChild(competencyStats);
    competencyContainer.appendChild(competencyItem);
  });

  mainContent.appendChild(leftSection);
  mainContent.appendChild(competencyContainer);

  // Assemble the card
  card.appendChild(header);
  card.appendChild(mainContent);

  return card;
}

function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create title
  const title = document.createElement('h3');
  title.textContent = `${quiz.title || `Quiz ${cardNumber}`}`;
  title.style.cssText = `
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  `;

  // Create progress bar (moved under title)
  const progressContainer = document.createElement('div');
  progressContainer.style.cssText = `
    margin-bottom: 1.5rem;
  `;

  const progressLabel = document.createElement('div');
  progressLabel.textContent = `Overall Performance: ${overallPercentage}%`;
  progressLabel.style.cssText = `
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
  `;

  const progressBar = document.createElement('div');
  progressBar.style.cssText = `
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
  `;

  const progressFill = document.createElement('div');
  progressFill.style.cssText = `
    width: ${overallPercentage}%;
    height: 100%;
    background-color: ${overallPercentage >= 70 ? '#10b981' : overallPercentage >= 50 ? '#f59e0b' : '#ef4444'};
    transition: width 0.3s ease;
  `;

  progressBar.appendChild(progressFill);
  progressContainer.appendChild(progressLabel);
  progressContainer.appendChild(progressBar);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyCard = document.createElement('div');
    competencyCard.style.cssText = `
      background-color: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 1rem;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;
    const competencyPercentage = Math.round((competencyCorrect / competencyTotal) * 100);

    const competencyHeader = document.createElement('h4');
    competencyHeader.textContent = competency;
    competencyHeader.style.cssText = `
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('div');
    competencyStats.textContent = `${competencyCorrect}/${competencyTotal} correct (${competencyPercentage}%)`;
    competencyStats.style.cssText = `
      font-size: 0.875rem;
      color: ${competencyPercentage >= 70 ? '#059669' : competencyPercentage >= 50 ? '#d97706' : '#dc2626'};
      font-weight: 500;
    `;

    competencyCard.appendChild(competencyHeader);
    competencyCard.appendChild(competencyStats);
    competencyContainer.appendChild(competencyCard);
  });

  // Assemble the card
  card.appendChild(title);
  card.appendChild(progressContainer);
  card.appendChild(competencyContainer);

  return card;
}

function createIndividualQuizCard(quiz, quizNumber) {
  const score = quiz.score || 0;
  const maxScore = quiz.maxScore || quiz.questions?.length || 1;
  const percent = Math.round((score / maxScore) * 100);
  const incorrect = maxScore - score;
  
  const dateObj = quiz.completedAt?.toDate?.() || quiz.createdAt?.toDate?.() || new Date();
  const timeStr = dateObj.toLocaleString();

  const cardDiv = document.createElement('div');
  cardDiv.className = 'individual-quiz-card';
  cardDiv.style.cssText = `
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 24px;
    width: 100%;
    margin-bottom: 16px;
  `;

  // Process competency data for this quiz
  const competencyStats = {};
  
  if (quiz.questionStructure) {
    quiz.questionStructure.forEach((question, index) => {
      const competency = question.competency;
      const questionId = `q${index + 1}`;
      const isCorrect = quiz.userAnswers?.[questionId] === question.correctAnswer;
      
      if (!competencyStats[competency]) {
        competencyStats[competency] = { correct: 0, total: 0 };
      }
      
      competencyStats[competency].total++;
      if (isCorrect) {
        competencyStats[competency].correct++;
      }
    });
  } else if (quiz.competencyStats) {
    Object.assign(competencyStats, quiz.competencyStats);
  } else {
    const allCompetencies = quiz.competencies || [];
    const correctCompetencies = quiz.correctCompetencies || [];
    
    allCompetencies.forEach(c => {
      competencyStats[c] = competencyStats[c] || { correct: 0, total: 0 };
      competencyStats[c].total++;
    });
    
    correctCompetencies.forEach(c => {
      competencyStats[c] = competencyStats[c] || { correct: 0, total: 0 };
      competencyStats[c].correct++;
    });
  }

  const competencyList = Object.entries(competencyStats)
    .map(([comp, { correct, total }]) => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; text-align: right;">
        <span style="color: #374151; font-size: 16px; font-weight: 400; text-align: left;">${comp}</span>
        <span style="color: #374151; font-size: 16px; font-weight: 500; text-align: right;">${correct} / ${total}</span>
      </div>
    `).join('');

  cardDiv.innerHTML = `
    <!-- Header with title and date - spans full width -->
   

    <!-- Main content: Score circle + stats on left, competencies on right -->
    <div style="display: flex; align-items: center; gap: 32px; width: 100%;">
      <!-- Left side: Score circle and stats side by side -->
      <div style="flex-shrink: 0; display: flex; align-items: center; gap: 24px;">
        <!-- Score Circle -->
        <div style="position: relative; width: 100px; height: 100px;">
          <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
            <path d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#e5e7eb" stroke-width="3" fill="none"/>
            <path stroke-dasharray="${percent}, 100" 
                  d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#3b82f6" stroke-width="3" fill="none" stroke-linecap="round"/>
          </svg>
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <span style="font-size: 24px; font-weight: 700; color: #3b82f6;">${percent}%</span>
          </div>
        </div>

        <!-- Stats to the right of circle -->
        <div style="text-align: left;">
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Correct</span>
            <span style="color: #3b82f6; font-weight: 600; margin-left: 8px;">${score}</span>
          </div>
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Incorrect</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">${incorrect}</span>
          </div>
          <div>
            <span style="color: #374151; font-weight: 600;">Skipped</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">0</span>
          </div>
        </div>
      </div>

      <!-- Right side: Competency breakdown -->
      <div style="flex: 1; text-align: right;">
         <div style="display: flex;  align-items: center; margin-bottom: 24px; width: 100%;">
      <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #374151;">Performance breakdown</h2><br>
      <span style="font-size: 14px; color: #6b7280; margin-left: 20px;">${timeStr}</span>
    </div>
        ${competencyList}
      </div>
    </div>
  `;

  return cardDiv;
}
// Global media recording variables
    let mediaRecorder;
    let mediaStream;
    let recordedChunks = [];
  
    // Tab underline + redirect
    function selectTab(selectedTab) {
      const tabText = selectedTab.textContent.trim();
      if (tabText === "Create") window.location.href = "create.html";
      if (tabText === "Resources") window.location.href = "practice.html";
      if (tabText === "Judging") window.location.href = "judging.html";
  
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
  
      const underline = document.querySelector('.tab-underline');
      underline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
      underline.style.width = `${selectedTab.offsetWidth}px`;
    }
  
    window.addEventListener('load', () => {
      const activeTab = document.querySelector('.tab.active');
      const underline = document.querySelector('.tab-underline');
      if (activeTab && underline) {
        underline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
        underline.style.width = `${activeTab.offsetWidth}px`;
      }
      if (window.feather) feather.replace();
    });
  
    // Accordion
    function toggleAccordion(button) {
      const content = button.nextElementSibling;
      const icon = button.querySelector('.chevron-icon');
      const isActive = button.classList.contains('active');
  
      button.classList.toggle('active');
      content.style.maxHeight = isActive ? null : content.scrollHeight + "px";
      if (icon) icon.classList.toggle('rotate', !isActive);
    }
  
    // Modals
    function openModal(id) {
      document.getElementById(id).style.display = 'block';
    }
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }
  
    function openWrittenModal() { openModal('writtenModal'); }
    function closeWrittenModal() { closeModal('writtenModal'); }
    function openSpeakingModal() { openModal('speakingModal'); }
    function closeSpeakingModal() { closeModal('speakingModal'); }
    function openCaseModal() { openModal('caseModal'); }
    function closeCaseModal() { closeModal('caseModal'); }
  
    // UI Selectors
    function selectTime(button) {
      document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
    }
  
    function selectDifficulty(button) {
      document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
    }
  
    function selectAllCompetencies() {
      document.querySelectorAll('.competency-option').forEach(box => {
        box.checked = true;
      });
    }
  
    // Question Generator (Speaking)
    function generateQuestions() {
      const speechInput = document.getElementById("speechInput");
      const speech = speechInput.value.trim();
      const questionArea = document.getElementById("questionArea");
      const questionList = document.getElementById("questionList");
  
      if (!speech) {
        alert("Paste your speech first!");
        return;
      }
  
      const questions = [
        "What was the main message of your speech?",
        "Why did you choose this topic?",
        "How would you connect this to a real-world issue?"
      ];
  
      speechInput.closest(".modal-section").style.display = "none";
      questionList.innerHTML = "";
      questions.forEach(q => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.textContent = q;
        questionList.appendChild(card);
      });
  
      questionArea.classList.remove("hidden");
    }
  
    // Case Prompt Generator
    function generateCase() {
      const selected = [...document.querySelectorAll('.competency-option:checked')];
      if (selected.length === 0 || selected.length > 5) {
        alert("Please choose between 1 to 5 competencies.");
        return;
      }
  
      const selectedCompetencies = selected.map(c => c.parentElement.textContent.trim());
      const difficulty = document.querySelector('.difficulty-btn.selected')?.textContent;
  
      if (!difficulty) {
        alert("Please select a difficulty.");
        return;
      }
  
      document.getElementById('casePromptSection').style.display = 'none';
      document.getElementById('caseDifficulty').textContent = difficulty;
      document.getElementById('caseCompetencies').textContent = selectedCompetencies.join(', ');
      document.getElementById('caseResultSection').style.display = 'block';
    }
  
    // --- Recording ---
    function stopAllMedia() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
    }
  
    function startAudio(context) {
      stopAllMedia();
      recordedChunks = [];
  
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaStream = stream;
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const audioURL = URL.createObjectURL(blob);
            const audio = document.getElementById(`audioPlayback${capitalize(context)}`);
            audio.src = audioURL;
            audio.style.display = 'block';
          };
          mediaRecorder.start();
          document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
        })
        .catch(err => {
          alert('Microphone permission denied.');
          console.error(err);
        });
    }
  
    function startVideo(context) {
      stopAllMedia();
      recordedChunks = [];
  
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          mediaStream = stream;
          const video = document.getElementById(`videoPreview${capitalize(context)}`);
          video.srcObject = stream;
          video.muted = true;
          video.play();
          video.style.display = 'block';
  
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoURL = URL.createObjectURL(blob);
            video.srcObject = null;
            video.src = videoURL;
            video.controls = true;
            video.muted = false;
            video.play();
          };
          mediaRecorder.start();
          document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
        })
        .catch(err => {
          alert('Camera permission denied.');
          console.error(err);
        });
    }
  
    function stopRecording(context) {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      const stopBtn = document.getElementById(`stopBtn${capitalize(context)}`);
      if (stopBtn) stopBtn.style.display = 'none';
    }
  
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ============ MEILISEARCH INTEGRATION ============
    // Meilisearch client setup (adjust if you use a different host)
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');

    if (searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }
    // =========== END MEILISEARCH ============
  </script>
  
  
  
  
  
</body>
</html>