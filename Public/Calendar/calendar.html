<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="calendar.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
        <li>üè† <span class="nav-label">Dashboard</span></li>
        <li>üìä <span class="nav-label">Stats</span></li>
        <li>üéØ <span class="nav-label">Goals</span></li>
        <li>üìÖ <span class="nav-label">Schedule</span></li>
        <li>‚öôÔ∏è <span class="nav-label">Settings</span></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <div class="container">
        <div class="info-banner">
            <span class="info-icon">i</span>
            <span class="info-text">
            What's this? Each event has a status tag: <b>Confirmed</b> (blue), <b>Pending</b> (yellow), or <b>Cancelled</b> (red) to help you track your calendar at a glance!
            </span>
          </div>
          

    <div class="section-header-inline">
      <h1 class="unit-title"><span class="title">Your Calendar</span></h1>
      <button class="competency-button">Schedule a Meeting +</button>
    </div>
      

          <p class="subtext">See your scheduled events from your calendar events links.</p>

      <div class="tabs">
        <div class="tab active">All</div>
        <div class="tab">Pending</div>
        <div class="tab">Rescheduled</div>
        <div class="tab">Upcoming</div>
        <div class="tab">Cancelled</div>
      </div>

      <!-- Event Cards -->
      <div class="timeline">
  <div class="timeline-line"></div>
  <!-- No static event cards here; JS will add them dynamically -->
</div>


    </div> <!-- end container -->
  </div> 

  <div class="modal-backdrop hidden"></div>
<div class="competency-modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Schedule a Meeting</h2>
      <span class="close-modal">‚úï</span>
    </div>
    <form id="scheduleForm" action="https://formspree.io/f/yourFormID" method="POST">
      <input type="hidden" id="meetingId" name="meetingId" value="" />

      <label>Name:</label>
      <input type="text" name="name" required />
      <label>Email:</label>
      <input type="email" name="email" required />
      <label>Preferred Date & Time:</label>
      <input type="datetime-local" name="datetime" required />
      <label>Competition:</label>
<select id="meetingComp" name="meetingComp" required>
  <option value="">Select Competition...</option>
  <!-- dynamically populated options go here -->
</select>

      <label>Message:</label>
      <textarea name="message" placeholder="Add a short note..."></textarea>
      <button type="submit">Submit</button>
    </form>
    <div id="confirmation" class="hidden">
      <p>Your meeting has been requested successfully!</p>
    </div>
  </div>
</div>


<div class="rsvp-modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Meeting Invitation</h2>
      <span class="rsvp-close">‚úï</span>
    </div>
    <div class="rsvp-message"></div>
    <div class="rsvp-actions">
      <button id="rsvpAccept" class="btn-accept">Accept</button>
      <button id="rsvpDecline" class="btn-decline">Decline</button>
      <button class="rsvp-close btn-neutral">Decide Later</button>
    </div>
  </div>
</div>

<!-- Add this right after the rsvp-modal div -->
<div class="choice-modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Meeting Options</h2>
      <span class="close-choice-modal">‚úï</span>
    </div>
    <div class="choice-options">
      <button id="rsvpChoiceBtn" class="choice-btn">RSVP</button>
      <button id="editChoiceBtn" class="choice-btn">Edit Meeting</button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

<script>
  // --- FIREBASE SETUP ---
  const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  document.addEventListener("DOMContentLoaded", () => {
    // --- Cache DOM elements ---
    const elements = {
      modal: document.querySelector(".competency-modal"),
      backdrop: document.querySelector(".modal-backdrop"),
      openBtn: document.querySelector(".competency-button"),
      closeBtns: document.querySelectorAll(".close-modal"),
      form: document.getElementById("scheduleForm"),
      confirmation: document.getElementById("confirmation"),
      timeline: document.querySelector(".timeline"),
      meetingComp: document.getElementById("meetingComp"),
      navbarSearch: document.getElementById("navbarSearch"),
      searchDD: document.getElementById("searchDropdown"),
      searchIcon: document.getElementById("navbarSearchIcon"),
      tabs: document.querySelectorAll(".tabs .tab"),
      underline: document.querySelector(".tab-underline"),
      rsvpModal: document.querySelector(".rsvp-modal"),
      rsvpMessage: document.querySelector(".rsvp-message"),
      acceptBtn: document.getElementById("rsvpAccept"),
      declineBtn: document.getElementById("rsvpDecline"),
      laterBtn: document.querySelector(".rsvp-close"),
      choiceModal: document.querySelector(".choice-modal"),
      closeChoiceBtns: document.querySelectorAll(".close-choice-modal"),
      rsvpChoiceBtn: document.getElementById("rsvpChoiceBtn"),
      editChoiceBtn: document.getElementById("editChoiceBtn")
    };

    // Hide modals initially
    elements.modal?.classList.add("hidden");
    elements.backdrop?.classList.add("hidden");
    elements.confirmation?.classList.add("hidden");
    elements.rsvpModal?.classList.add("hidden");

    // --- Utility Functions ---
    const utils = {
      parseLocalDateTime: (str) => {
        if (!str) return new Date();
        const [date, time] = str.split("T");
        const [y, m, d] = date.split("-").map(Number);
        const [h, min] = time?.split(":").map(Number) || [0, 0];
        return new Date(y, m-1, d, h, min);
      },
      animateBanner: (newHtml) => {
        const banner = document.querySelector(".info-text");
        if (!banner) return;
        banner.classList.add("fade-out");
        setTimeout(() => {
          banner.innerHTML = newHtml;
          banner.classList.remove("fade-out");
        }, 300);
      },
      updateTabUnderline: (tab) => {
        if (!elements.underline || !tab) return;
        elements.underline.style.transform = `translateX(${tab.offsetLeft}px)`;
        elements.underline.style.width = `${tab.offsetWidth}px`;
      }
    };

    // --- Data Functions ---
    const dataHandler = {
      populateCompetitionOptions: async (current = "") => {
        if (!elements.meetingComp) return;
        
        elements.meetingComp.innerHTML = `<option value="">Select Competition‚Ä¶</option>`;
        const user = auth.currentUser || await new Promise(res => auth.onAuthStateChanged(res));
        if (!user) return;

        try {
          const snap = await db.collection("users").doc(user.uid).get();
          const data = snap.exists ? snap.data() : {};
          let comps = [];
          
          if (Array.isArray(data.competitions)) comps.push(...data.competitions);
          if (data.isMentor) {
            const mc = data.mentorCompetition;
            if (Array.isArray(mc)) comps.push(...mc);
            else if (mc) comps.push(mc);
          }
          if (current && !comps.includes(current)) comps.push(current);
          
          Array.from(new Set(comps)).forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            elements.meetingComp.appendChild(opt);
          });
        } catch (error) {
          console.error("Error loading competitions:", error);
        }
      },
      
      saveMeeting: async (meetingData, isEdit = false) => {
        try {
          const batch = db.batch();
          
          // Get all mentees in the competition
          const menteesQuery = db.collection("users")
            .where("competitions", "array-contains", meetingData.competition);
          
          // Get all mentors for the competition
          const mentorsQuery = db.collection("users")
            .where("mentorCompetition", "==", meetingData.competition);
          
          const [menteesSnapshot, mentorsSnapshot] = await Promise.all([
            menteesQuery.get(),
            mentorsQuery.get()
          ]);
          
          // Combine all unique user IDs
          const uids = new Set();
          menteesSnapshot.forEach(doc => uids.add(doc.id));
          mentorsSnapshot.forEach(doc => uids.add(doc.id));
          
          // Set the total users count (including creator)
          meetingData.rsvpStatus = meetingData.rsvpStatus || {};
          meetingData.rsvpStatus.totalUsers = uids.size;
          
          // Save meeting for all users
          uids.forEach(u => {
            const ref = db.collection("users").doc(u).collection("meetings").doc(meetingData.meetingId);
            batch.set(ref, meetingData, { merge: true });
          });

          await batch.commit();
          return true;
        } catch (error) {
          console.error("Error saving meeting:", error);
          return false;
        }
      }
    };

    // --- Modal Functions ---
    const modalHandler = {
      currentModal: null,
      
      initModals: function() {
        elements.modal?.classList.add("hidden");
        elements.rsvpModal?.classList.add("hidden");
        elements.choiceModal?.classList.add("hidden");
        elements.backdrop?.classList.remove("active");
      },

      showChoiceModal: function(meetingId) {
        this.closeAllModals();
        elements.choiceModal.dataset.meetingId = meetingId;
        elements.choiceModal.classList.remove("hidden");
        elements.backdrop.classList.add("active");
        document.body.classList.add("modal-open");
        this.currentModal = 'choice';
      },

      showModal: async function(meetingData = null) {
        this.closeAllModals();
        
        // Set modal styling to match your working version
        if (elements.modal) {
          elements.modal.style.cssText = `
            position: fixed !important;
            top: 58% !important;
            left: 50% !important;
            width: 100% !important;
            height: 100% !important;
            background-color: transparent !important;
            display: flex !important;
            align-items: center !important;
            z-index: 1000 !important;
            transform: translate(-50%, -50%) !important;
          `;
          
          // Set content styling
          const modalContent = elements.modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.style.cssText = `
              background: white !important;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              width: 90%;
              max-width: 500px;
              margin: 20px auto;
              padding: 25px;
            `;
          }
        }
        
        // Show modal
        elements.modal?.classList.remove("hidden");
        document.body.classList.add("modal-open");
        
        // Reset or populate form
        if (elements.form) {
          elements.form.classList.remove("hidden");
          if (meetingData) {
            elements.form.name.value = meetingData.name || '';
            elements.form.email.value = meetingData.email || '';
            elements.form.datetime.value = meetingData.datetime || '';
            elements.form.message.value = meetingData.message || '';
            elements.form.meetingComp.value = meetingData.competition || '';
            elements.form.dataset.meetingId = meetingData.meetingId || '';
          } else {
            elements.form.reset();
            elements.form.dataset.meetingId = '';
          }
        }
        
        if (elements.confirmation) {
          elements.confirmation.classList.add("hidden");
        }
        
        await dataHandler.populateCompetitionOptions(meetingData?.competition);
        this.currentModal = 'edit';
      },

      showRsvpModal: function(meeting) {
        this.closeAllModals();
        try {
          const options = { 
            weekday: 'long', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit', 
            minute: '2-digit'
          };
          const meetingDate = new Date(meeting.datetime).toLocaleString('en-US', options);
          
          if (elements.rsvpMessage) {
            elements.rsvpMessage.innerHTML = `
              <div class="rsvp-header">
                <h3>Meeting Invitation</h3>
                <p>From: ${meeting.scheduledByName || "Mentor"}</p>
                <h4>${meeting.name}</h4>
              </div>
              <div class="rsvp-details">
                <p><strong>When:</strong> ${meetingDate}</p>
                <p><strong>Competition:</strong> ${meeting.competition || 'General'}</p>
                ${meeting.message ? `<p class="meeting-note">${meeting.message}</p>` : ''}
              </div>
            `;
          }
          
          if (elements.rsvpModal) {
            elements.rsvpModal.dataset.meetingId = meeting.meetingId;
            elements.rsvpModal.dataset.scheduledby = meeting.scheduledBy;
          }
          elements.backdrop?.classList.add("active");
          elements.rsvpModal?.classList.remove("hidden");
          this.currentModal = 'rsvp';
        } catch (error) {
          console.error("Error showing RSVP modal:", error);
        }
      },

      closeAllModals: function() {
        elements.modal?.classList.add("hidden");
        elements.rsvpModal?.classList.add("hidden");
        elements.choiceModal?.classList.add("hidden");
        elements.backdrop?.classList.remove("active");
        document.body.classList.remove("modal-open");
        this.currentModal = null;
      },

      closeModal: function() {
        if (elements.modal) {
          elements.modal.style.display = 'none';
          elements.modal.classList.add("hidden");
        }
        elements.backdrop?.classList.remove("active");
        document.body.classList.remove("modal-open");
        // Reset form state
        if (elements.form) {
          elements.form.reset();
          elements.form.classList.remove("hidden");
        }
        if (elements.confirmation) {
          elements.confirmation.classList.add("hidden");
        }
      },
      
      closeRsvpModal: function() {
        elements.rsvpModal?.classList.add("hidden");
        elements.backdrop?.classList.remove("active");
        document.body.classList.remove("modal-open");
      },
      
      closeChoiceModal: function() {
        elements.choiceModal?.classList.add("hidden");
        elements.backdrop?.classList.remove("active");
        document.body.classList.remove("modal-open");
      },

      checkBackdrop: function() {
        if ((elements.modal && !elements.modal.classList.contains("hidden")) || 
            (elements.rsvpModal && !elements.rsvpModal.classList.contains("hidden")) || 
            (elements.choiceModal && !elements.choiceModal.classList.contains("hidden"))) {
          return;
        }
        elements.backdrop?.classList.remove("active");
        document.body.classList.remove("modal-open");
      }
    };

    // --- Event Listeners ---
    const setupEventListeners = () => {
      // Modal controls
      elements.closeBtns?.forEach(btn => btn.addEventListener("click", (e) => {
        e.preventDefault();
        modalHandler.closeModal();
      }));

      // Backdrop click handler
      elements.backdrop?.addEventListener("click", (e) => {
        if (e.target === elements.backdrop) {
          modalHandler.closeModal();
        }
      });

      elements.openBtn?.addEventListener("click", () => modalHandler.showModal());

      // Form submission
      elements.form?.addEventListener("submit", async e => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return alert("Please sign in first");

        const isEdit = !!elements.form.dataset.meetingId;
        const meetingId = elements.form.dataset.meetingId || db.collection("meetings").doc().id;
        const newDate = elements.form.datetime.value;
        
        let status = "pending";
        if (isEdit) {
          const orig = (await db.collection("users").doc(user.uid)
            .collection("meetings").doc(meetingId).get()).data() || {};
          status = (orig.datetime && orig.datetime !== newDate)
            ? "rescheduled" : (orig.status || "pending");
        }

        const meetingData = {
          meetingId,
          name: elements.form.name.value,
          email: elements.form.email.value,
          datetime: newDate,
          message: elements.form.message.value,
          competition: elements.form.meetingComp.value,
          scheduledBy: user.uid,
          status,
          rsvpStatus: {
            required: true,
            responses: { [user.uid]: "accepted" },
            totalUsers: 1
          },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          const success = await dataHandler.saveMeeting(meetingData, isEdit);
          if (success) {
            // Show confirmation message
            elements.confirmation?.classList.remove("hidden");
            elements.form?.classList.add("hidden");
            
            // Close modal after 2 seconds
            setTimeout(() => {
              modalHandler.closeModal();
              // Reset form for next use
              elements.form?.reset();
              elements.form?.classList.remove("hidden");
              elements.confirmation?.classList.add("hidden");
            }, 2000);
          }
        } catch (error) {
          console.error("Error saving meeting:", error);
          alert("Failed to save meeting. Please try again.");
        }
      });

      // RSVP button handlers
      document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("edit-btn")) {
    e.preventDefault();
    const eventCard = e.target.closest(".timeline-event");
    const meetingId = eventCard?.dataset.id;
    if (!meetingId) return;

    const user = auth.currentUser;
    if (!user) return alert("Please sign in first");

    try {
      // Get the meeting document
      const doc = await db.collection("users").doc(user.uid)
        .collection("meetings").doc(meetingId).get();
      
      if (!doc.exists) return alert("Meeting not found!");
      
      const meetingData = doc.data();
      
      // Always show edit modal for everyone
      await modalHandler.showModal(meetingData);
      
    } catch (error) {
      console.error("Error loading meeting:", error);
      alert("Failed to load meeting details.");
    }
  }
});

      // RSVP Choice
      elements.rsvpChoiceBtn?.addEventListener("click", async () => {
        const meetingId = elements.choiceModal?.dataset.meetingId;
        if (!meetingId) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        try {
          const doc = await db.collection("users").doc(user.uid)
            .collection("meetings").doc(meetingId).get();
          
          if (doc.exists) {
            modalHandler.closeAllModals();
            modalHandler.showRsvpModal(doc.data());
          }
        } catch (error) {
          console.error("Error loading meeting:", error);
          alert("Failed to load meeting details.");
        }
      });

      // Edit Choice
      elements.editChoiceBtn?.addEventListener("click", async () => {
        const meetingId = elements.choiceModal?.dataset.meetingId;
        if (!meetingId) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        try {
          const doc = await db.collection("users").doc(user.uid)
            .collection("meetings").doc(meetingId).get();
          
          if (doc.exists) {
            modalHandler.closeAllModals();
            await modalHandler.showModal(doc.data());
          }
        } catch (error) {
          console.error("Error loading meeting:", error);
          alert("Failed to load meeting details.");
        }
      });

      // Add close handler for choice modal
      elements.closeChoiceBtns?.forEach(btn => {
        btn.addEventListener("click", () => {
          modalHandler.closeChoiceModal();
          modalHandler.closeModal();
        });
      });

      // Tab switching
      elements.tabs?.forEach((tab, idx) => {
        tab.addEventListener("click", () => {
          elements.tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          utils.updateTabUnderline(tab);

          const now = new Date();
          const nextWeek = new Date(now);
          nextWeek.setDate(now.getDate() + 7);

          document.querySelectorAll(".timeline-event").forEach(ev => {
            const status = ev.querySelector(".status-tag")?.textContent.trim().toLowerCase() || "";
            const dt = utils.parseLocalDateTime(ev.dataset.datetime);
            
            let show = false;
            switch(idx) {
              case 0: show = true; break;
              case 1: show = status === "pending"; break;
              case 2: show = status === "rescheduled"; break;
              case 3: show = dt >= now && dt <= nextWeek; break;
              case 4: show = status === "cancelled"; break;
            }
            
            ev.style.display = show ? "" : "none";
          });

          const bannerMessages = [
            `Showing <b>all</b> events`,
            `Showing <b>pending</b> events`,
            `Showing <b>rescheduled</b> events`,
            `Showing events in the <b>next 7 days</b>`,
            `Showing <b>cancelled</b> events`
          ];
          utils.animateBanner(bannerMessages[idx] || bannerMessages[0]);
        });
      });

      // Search functionality
      if (window.MeiliSearch && elements.navbarSearch && elements.searchDD && elements.searchIcon) {
        const client = new MeiliSearch({ host: "http://127.0.0.1:7700" });
        const index = client.index("content");

        elements.navbarSearch.addEventListener("input", async () => {
          const q = elements.navbarSearch.value.trim();
          if (!q) {
            elements.searchDD.style.display = "none";
            return;
          }

          try {
            const { hits } = await index.search(q, { limit: 5 });
            if (!hits.length) {
              elements.searchDD.style.display = "none";
              return;
            }

            elements.searchDD.innerHTML = hits.map(d => `
              <div class="dropdown-result" tabindex="0" data-url="${d.url}">
                <strong>${d.title}</strong><br>
                <small>${d.category || ""}${d.tags ? " | " + d.tags.join(",") : ""}</small>
              </div>
            `).join("");
            elements.searchDD.style.display = "block";
          } catch (error) {
            console.error("Search error:", error);
            elements.searchDD.style.display = "none";
          }
        });

        elements.searchDD.addEventListener("click", e => {
          const item = e.target.closest(".dropdown-result");
          if (item?.dataset.url) window.location.href = item.dataset.url;
        });

        document.addEventListener("click", e => {
          if (!elements.navbarSearch.contains(e.target) && !elements.searchDD.contains(e.target)) {
            elements.searchDD.style.display = "none";
          }
        });

        elements.searchIcon.addEventListener("click", () => {
          elements.navbarSearch.focus();
          elements.navbarSearch.dispatchEvent(new Event("input"));
        });
      }

      // RSVP Accept Handler
      document.body.addEventListener("click", async (e) => {
  if (e.target && (e.target.id === "rsvpAccept" || 
      (e.target.classList.contains("rsvp-btn") && e.target.classList.contains("accept")))) {
    const user = auth.currentUser;
    if (!user) return alert("Please sign in!");

    // Get meeting ID from either modal or button
    let meetingId;
    let modal;
    if (e.target.id === "rsvpAccept") {
      modal = document.querySelector(".rsvp-modal");
      meetingId = modal?.dataset.meetingId;
    } else {
      meetingId = e.target.dataset.id;
    }

    if (!meetingId) return alert("Meeting ID not found!");

    try {
      // Get the meeting document from the current user's collection
      const userMeetingRef = db.collection("users").doc(user.uid)
        .collection("meetings").doc(meetingId);
      const userMeetingDoc = await userMeetingRef.get();

      if (!userMeetingDoc.exists) return alert("Meeting not found!");
      const meetingData = userMeetingDoc.data();

      // Get the creator's ID
      const creatorId = meetingData.scheduledBy;

      // Get all users in this competition (mentees and mentors)
      const menteesQuery = db.collection("users")
        .where("competitions", "array-contains", meetingData.competition);
      const mentorsQuery = db.collection("users")
        .where("mentorCompetition", "==", meetingData.competition);

      const [menteesSnap, mentorsSnap] = await Promise.all([
        menteesQuery.get(),
        mentorsQuery.get()
      ]);

      // Combine all user IDs
      const allUids = new Set();
      menteesSnap.forEach(doc => allUids.add(doc.id));
      mentorsSnap.forEach(doc => allUids.add(doc.id));
      allUids.add(creatorId); // Ensure creator is included

      // Create the updated responses object
      const updatedResponses = {
        ...(meetingData.rsvpStatus?.responses || {}),
        [user.uid]: "accepted"
      };

      // Calculate the new accepted count
      const acceptedCount = Object.values(updatedResponses).filter(v => v === "accepted").length;
      const totalUsers = allUids.size;

      // Prepare the update data
      const updateData = {
        "rsvpStatus.responses": updatedResponses,
        "rsvpStatus.totalUsers": totalUsers,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // If this was a pending meeting, update the status
      if (meetingData.status === "pending") {
        updateData.status = "confirmed";
      }

      // Batch update all user's meeting documents
      const batch = db.batch();
      allUids.forEach(uid => {
        const ref = db.collection("users").doc(uid)
          .collection("meetings").doc(meetingId);
        batch.update(ref, updateData);
      });

      await batch.commit();
      
      // Close modal if it was open
      if (modal) {
        modal.classList.add("hidden");
        document.body.classList.remove("modal-open");
      }
      
      // Show success feedback
      alert("You've accepted this meeting!");
    } catch (error) {
      console.error("Error accepting meeting:", error);
      alert("Failed to accept meeting. Please try again.");
    }
  }
});

      // Decline button handler
      elements.declineBtn?.addEventListener("click", async () => {
        const meetingId = elements.rsvpModal?.dataset.meetingId;
        const user = auth.currentUser;
        if (!user || !meetingId) return;

        try {
          // First get the meeting data from creator's collection
          const creatorMeetingRef = db.collection("users").doc(user.uid)
            .collection("meetings").doc(meetingId);
          const meetingDoc = await creatorMeetingRef.get();
          
          if (!meetingDoc.exists) return;
          
          const meetingData = meetingDoc.data();
          const creatorId = meetingData.scheduledBy;
          
          // Get all users in this competition
          const allUsers = await db.collection("users")
            .where("competitions", "array-contains", meetingData.competition)
            .get();
          
          const batch = db.batch();
          
          // Update all instances
          allUsers.forEach(userDoc => {
            const ref = db.collection("users").doc(userDoc.id)
              .collection("meetings").doc(meetingId);
            batch.update(ref, {
              "rsvpStatus.responses": {
                ...meetingData.rsvpStatus.responses,
                [user.uid]: "declined"
              },
              status: "declined",
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          
          await batch.commit();
          modalHandler.closeRsvpModal();
          location.reload();
        } catch (error) {
          console.error("Error declining meeting:", error);
          alert("Failed to decline meeting. Please try again.");
        }
      });

      elements.laterBtn?.addEventListener("click", modalHandler.closeRsvpModal);

      // Edit button handling
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("edit-btn")) {
          const eventCard = e.target.closest(".timeline-event");
          const meetingId = eventCard?.dataset.id;
          if (!meetingId) return;

          const user = auth.currentUser;
          if (!user) return alert("Please sign in first");

          try {
            const doc = await db.collection("users").doc(user.uid)
              .collection("meetings").doc(meetingId).get();
            
            if (doc.exists) {
              const meetingData = doc.data();
              if (meetingData.scheduledBy === user.uid) {
                // Creator can edit the meeting
                await modalHandler.showModal(meetingData);
              } else {
                // Non-creator can RSVP
                modalHandler.showRsvpModal(meetingData);
              }
            }
          } catch (error) {
            console.error("Error loading meeting:", error);
            alert("Failed to load meeting details.");
          }
        }
      });
    };

    // --- Render Functions ---
    const render = {
      meetingCard: (m) => {
  const d = new Date(m.datetime);
  const wd = d.toLocaleDateString("en-US", { weekday: "short" });
  const day = String(d.getDate()).padStart(2, "0");
  const tm = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const isCreator = m.scheduledBy === auth.currentUser?.uid;
  const userResponse = m.rsvpStatus?.responses?.[auth.currentUser?.uid];
  const requiresResponse = m.rsvpStatus?.required && !userResponse && !isCreator;

  // Calculate RSVP counts
  const responses = m.rsvpStatus?.responses || {};
  const totalUsers = m.rsvpStatus?.totalUsers || Object.keys(responses).length || 1;
  const acceptedCount = Object.values(responses).filter(v => v === "accepted").length;

  return `
    <div class="timeline-event" data-id="${m.meetingId}" data-datetime="${m.datetime}">
      <div class="event-card">
        <div class="event-date">
          <div class="weekday">${wd}</div>
          <div class="day">${day}</div>
        </div>
        <div class="event-content">
          <div class="event-row">
            <div class="event-info">${tm} ‚Ä¢ ${m.competition || 'General'}</div>
            <div class="event-title">
              ${m.name} <span class="status-tag ${m.status || 'pending'}">${m.status || 'pending'}</span>
            </div>
          </div>
          <div class="event-actions">
            ${requiresResponse ? `
              <div class="rsvp-buttons">
                <button class="rsvp-btn accept" data-id="${m.meetingId}">Accept</button>
                <button class="rsvp-btn decline" data-id="${m.meetingId}">Decline</button>
              </div>
            ` : ''}
            <div class="action-group">
              ${isCreator ? `<span class="creator-badge">You scheduled</span>` : ''}
              <span class="rsvp-count">${acceptedCount}/${totalUsers} accepted</span>
              <button class="edit-btn" data-id="${m.meetingId}">Edit Meeting</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
},

      timeline: (meetings) => {
        if (!elements.timeline) return;
        elements.timeline.innerHTML = '<div class="timeline-line"></div>';
        meetings.forEach(m => {
          elements.timeline.insertAdjacentHTML("beforeend", render.meetingCard(m));
        });
      }
    };

    // --- Initialize ---
    const init = async () => {
      setupEventListeners();
      
      auth.onAuthStateChanged(user => {
        if (!user) return;
        
        // Load meetings
        db.collection("users").doc(user.uid)
          .collection("meetings")
          .orderBy("datetime")
          .onSnapshot(snap => {
            const meetings = snap.docs.map(doc => ({ ...doc.data(), meetingId: doc.id }));
            render.timeline(meetings);
            
            // Check for pending RSVPs
            const pendingMeeting = meetings.find(m => 
              m.scheduledBy !== user.uid && 
              m.rsvpStatus?.required &&
              !m.rsvpStatus?.responses?.[user.uid]
            );
            
            if (pendingMeeting) {
              modalHandler.showRsvpModal(pendingMeeting);
            }
          }, error => {
            console.error("Meetings listener error:", error);
          });

        // Activate first tab
        elements.tabs[0]?.dispatchEvent(new Event("click"));
      });

      if (window.feather) feather.replace();
    };

    init();
  });
</script>









</body>
</html>
